<%- include('../partials/head', { title: 'System Check - ' + exam.title }) %>

<div class="min-h-screen bg-gradient-to-br from-blue-600 via-indigo-700 to-purple-800 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-8 fade-in">
    <div class="text-center mb-6">
      <h1 class="text-2xl font-bold text-gray-800">System Compatibility Check</h1>
      <p class="text-gray-500 mt-1"><%= exam.title %></p>
    </div>

    <!-- Progress Steps -->
    <div class="flex items-center justify-center mb-8 space-x-2">
      <div class="flex items-center space-x-2">
        <div class="w-8 h-8 bg-indigo-600 text-white rounded-full flex items-center justify-center text-sm font-bold" id="step1">1</div>
        <span class="text-sm font-medium text-indigo-600">System Check</span>
      </div>
      <div class="w-8 h-0.5 bg-gray-300"></div>
      <div class="flex items-center space-x-2">
        <div class="w-8 h-8 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center text-sm font-bold">2</div>
        <span class="text-sm text-gray-400">A/V Check</span>
      </div>
      <div class="w-8 h-0.5 bg-gray-300"></div>
      <div class="flex items-center space-x-2">
        <div class="w-8 h-8 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center text-sm font-bold">3</div>
        <span class="text-sm text-gray-400">Rules</span>
      </div>
      <div class="w-8 h-0.5 bg-gray-300"></div>
      <div class="flex items-center space-x-2">
        <div class="w-8 h-8 bg-gray-300 text-gray-500 rounded-full flex items-center justify-center text-sm font-bold">4</div>
        <span class="text-sm text-gray-400">Exam</span>
      </div>
    </div>

    <!-- Check Items -->
    <div class="space-y-4" id="checkList">
      <!-- Browser Check -->
      <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border" id="browserCheck">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center" id="browserIcon">
            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9"/></svg>
          </div>
          <div>
            <p class="font-semibold text-gray-800">Browser Compatibility</p>
            <p class="text-xs text-gray-500" id="browserInfo">Checking...</p>
          </div>
        </div>
        <div id="browserStatus" class="text-sm font-medium text-gray-400">Checking...</div>
      </div>

      <!-- Internet Speed -->
      <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border" id="speedCheck">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center" id="speedIcon">
            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
          </div>
          <div>
            <p class="font-semibold text-gray-800">Internet Connection</p>
            <p class="text-xs text-gray-500" id="speedInfo">Testing speed...</p>
          </div>
        </div>
        <div id="speedStatus" class="text-sm font-medium text-gray-400">Checking...</div>
      </div>

      <!-- Screen Resolution -->
      <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border" id="screenCheck">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center" id="screenIcon">
            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
          </div>
          <div>
            <p class="font-semibold text-gray-800">Screen Resolution</p>
            <p class="text-xs text-gray-500" id="screenInfo">Checking...</p>
          </div>
        </div>
        <div id="screenStatus" class="text-sm font-medium text-gray-400">Checking...</div>
      </div>

      <!-- Camera Permission -->
      <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border" id="cameraCheck">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center" id="cameraIcon">
            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
          </div>
          <div>
            <p class="font-semibold text-gray-800">Camera Access</p>
            <p class="text-xs text-gray-500" id="cameraInfo">Requesting permission...</p>
          </div>
        </div>
        <div id="cameraStatus" class="text-sm font-medium text-gray-400">Pending...</div>
      </div>

      <!-- Microphone Permission -->
      <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border" id="micCheck">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center" id="micIcon">
            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-14 0m14 0a7 7 0 00-14 0m14 0v1a7 7 0 01-14 0v-1m7 8v4m-4 0h8"/></svg>
          </div>
          <div>
            <p class="font-semibold text-gray-800">Microphone Access</p>
            <p class="text-xs text-gray-500" id="micInfo">Requesting permission...</p>
          </div>
        </div>
        <div id="micStatus" class="text-sm font-medium text-gray-400">Pending...</div>
      </div>

      <!-- Speaker Check -->
      <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border" id="speakerCheck">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gray-200 rounded-lg flex items-center justify-center" id="speakerIcon">
            <svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/></svg>
          </div>
          <div>
            <p class="font-semibold text-gray-800">Speaker Check</p>
            <p class="text-xs text-gray-500" id="speakerInfo">Checking audio output...</p>
          </div>
        </div>
        <div id="speakerStatus" class="text-sm font-medium text-gray-400">Checking...</div>
      </div>
    </div>

    <!-- Warning for denied permissions -->
    <div id="permissionWarning" class="hidden mt-4 bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm">
      Camera and Microphone access are mandatory for the proctored exam. Please allow permissions and refresh the page.
    </div>

    <!-- Continue Button -->
    <div class="mt-8 text-center">
      <button id="continueBtn" disabled
              class="px-8 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition shadow-lg disabled:bg-gray-300 disabled:cursor-not-allowed cursor-pointer"
              onclick="proceedToAVCheck()">
        Continue to Audio/Video Verification
        <svg class="w-4 h-4 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>
      </button>
    </div>
  </div>
</div>

<script>
let allChecksPass = { browser: false, speed: false, screen: false, camera: false, mic: false, speaker: false };

function setStatus(id, pass, info) {
  const statusEl = document.getElementById(id + 'Status');
  const iconEl = document.getElementById(id + 'Icon');
  const infoEl = document.getElementById(id + 'Info');
  if (pass) {
    statusEl.textContent = 'Passed';
    statusEl.className = 'text-sm font-medium text-green-600';
    iconEl.className = 'w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center';
  } else {
    statusEl.textContent = 'Failed';
    statusEl.className = 'text-sm font-medium text-red-600';
    iconEl.className = 'w-10 h-10 bg-red-100 rounded-lg flex items-center justify-center';
  }
  if (info) infoEl.textContent = info;
}

// Browser check
(function checkBrowser() {
  const ua = navigator.userAgent;
  const isChrome = /Chrome/.test(ua) && !/Edg/.test(ua);
  const isEdge = /Edg/.test(ua);
  const isFirefox = /Firefox/.test(ua);
  const browserName = isChrome ? 'Google Chrome' : isEdge ? 'Microsoft Edge' : isFirefox ? 'Firefox' : 'Other';
  const pass = isChrome || isEdge || isFirefox;
  allChecksPass.browser = pass;
  setStatus('browser', pass, browserName + (pass ? ' - Compatible' : ' - Not recommended'));
  checkAllDone();
})();

// Speed check (simple test)
(async function checkSpeed() {
  try {
    const start = Date.now();
    await fetch('/css/output.css', { cache: 'no-store' });
    const elapsed = Date.now() - start;
    const pass = elapsed < 5000;
    allChecksPass.speed = pass;
    setStatus('speed', pass, pass ? 'Connection stable (' + elapsed + 'ms)' : 'Slow connection detected');
  } catch {
    setStatus('speed', false, 'Connection test failed');
  }
  checkAllDone();
})();

// Screen resolution
(function checkScreen() {
  const w = screen.width, h = screen.height;
  const pass = w >= 1024 && h >= 600;
  allChecksPass.screen = pass;
  setStatus('screen', pass, w + 'x' + h + (pass ? ' - OK' : ' - Minimum 1024x600 required'));
  checkAllDone();
})();

// Camera & Microphone
(async function checkMedia() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    allChecksPass.camera = true;
    allChecksPass.mic = true;
    setStatus('camera', true, 'Camera access granted');
    setStatus('mic', true, 'Microphone access granted');
    stream.getTracks().forEach(t => t.stop());
  } catch (err) {
    allChecksPass.camera = false;
    allChecksPass.mic = false;
    setStatus('camera', false, 'Camera permission denied');
    setStatus('mic', false, 'Microphone permission denied');
    document.getElementById('permissionWarning').classList.remove('hidden');
  }
  checkAllDone();
})();

// Speaker check
(function checkSpeaker() {
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  allChecksPass.speaker = !!audioCtx;
  setStatus('speaker', allChecksPass.speaker, audioCtx ? 'Audio output available' : 'No audio output detected');
  audioCtx.close();
  checkAllDone();
})();

function checkAllDone() {
  const allPass = Object.values(allChecksPass).every(v => v);
  document.getElementById('continueBtn').disabled = !allPass;
}

async function proceedToAVCheck() {
  const btn = document.getElementById('continueBtn');
  btn.disabled = true;
  btn.textContent = 'Please wait...';

  const res = await fetch('/exam/compatibility-done', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      browser_info: navigator.userAgent.substring(0, 200),
      screen_resolution: screen.width + 'x' + screen.height
    })
  });
  const data = await res.json();
  if (data.success) window.location.href = data.redirect;
}
</script>

<%- include('../partials/footer') %>
