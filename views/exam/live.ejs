<%- include('../partials/head', { title: 'Live Examination' }) %>

<div class="min-h-screen bg-gray-100 flex flex-col" id="examContainer">
  <!-- Top Bar -->
  <div class="bg-white shadow-sm border-b px-4 py-2 flex items-center justify-between sticky top-0 z-50">
    <div class="flex items-center space-x-3">
      <div class="w-8 h-8 bg-indigo-600 rounded-lg flex items-center justify-center">
        <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
      </div>
      <div>
        <h1 class="font-bold text-gray-800 text-sm"><%= session.exam_title %></h1>
        <p class="text-xs text-gray-500"><%= studentName %></p>
      </div>
    </div>

    <!-- Timer -->
    <div class="flex items-center space-x-2">
      <div id="timerDisplay" class="bg-red-50 border border-red-200 rounded-lg px-4 py-1.5 flex items-center space-x-2">
        <svg class="w-4 h-4 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        <span id="timer" class="font-mono font-bold text-red-600">--:--</span>
      </div>
      <button onclick="requestFullscreen()" class="p-2 text-gray-500 hover:text-gray-700 transition cursor-pointer" title="Fullscreen">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
      </button>
    </div>
  </div>

  <div class="flex flex-1 overflow-hidden">
    <!-- Main Content Area -->
    <div class="flex-1 overflow-y-auto p-6">
      <!-- Question Display -->
      <div class="max-w-3xl mx-auto">
        <div class="bg-white rounded-xl shadow-sm border p-6 mb-4" id="questionCard">
          <div class="flex items-center justify-between mb-4">
            <span class="text-sm font-medium text-indigo-600" id="questionSection">Section</span>
            <span class="text-sm text-gray-500" id="questionNumber">Question 1 of <%= session.total_questions %></span>
          </div>

          <h2 class="text-lg font-semibold text-gray-800 mb-6" id="questionText">Loading...</h2>

          <div id="questionImageContainer" class="mb-4 hidden">
            <img id="questionImage" class="rounded-lg max-w-full max-h-80 border" src="">
          </div>

          <div class="space-y-3" id="optionsContainer">
            <!-- Options will be populated by JS for MCQ -->
          </div>

          <!-- Long Answer / Descriptive textarea -->
          <div id="longAnswerContainer" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2">Write your answer below:</label>
            <textarea id="longAnswerText" rows="10" placeholder="Type your detailed answer here..."
                      class="w-full px-4 py-3 border-2 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-y"
                      oninput="autoSaveLongAnswer()"></textarea>
            <div class="flex justify-between items-center mt-2">
              <p class="text-xs text-gray-400" id="charCount">0 characters</p>
              <p class="text-xs text-green-600 hidden" id="saveIndicator">Saved</p>
            </div>
          </div>

          <!-- File Upload Container (for file_upload question type) -->
          <div id="fileUploadContainer" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2">Upload your file:</label>
            <div id="fileDropZone" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-indigo-400 transition cursor-pointer"
                 ondragover="event.preventDefault(); this.classList.add('border-indigo-500','bg-indigo-50')"
                 ondragleave="this.classList.remove('border-indigo-500','bg-indigo-50')"
                 ondrop="handleFileDrop(event)"
                 onclick="document.getElementById('fileInput').click()">
              <svg class="w-10 h-10 text-gray-400 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
              <p class="text-sm text-gray-600 font-medium">Drag & drop your file here</p>
              <p class="text-xs text-gray-400 mt-1">or click to browse</p>
              <p class="text-xs text-gray-400 mt-2" id="fileConstraints">Accepted: PDF, JPG, PNG | Max: 10MB</p>
            </div>
            <input type="file" id="fileInput" class="hidden" onchange="handleFileSelect(this.files[0])">

            <!-- Uploaded file info -->
            <div id="uploadedFileInfo" class="hidden mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2">
                  <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                  <span class="text-sm text-green-700 font-medium" id="uploadedFileName">file.pdf</span>
                </div>
                <button onclick="removeUploadedFile()" class="text-red-500 hover:text-red-700 text-xs font-medium cursor-pointer">Remove</button>
              </div>
            </div>

            <!-- Upload progress -->
            <div id="uploadProgress" class="hidden mt-3">
              <div class="flex items-center space-x-2">
                <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                  <div id="uploadProgressBar" class="h-full bg-indigo-500 rounded-full transition-all" style="width: 0%"></div>
                </div>
                <span class="text-xs text-gray-500" id="uploadProgressText">Uploading...</span>
              </div>
            </div>
          </div>

          <!-- Summary Writing Container (for summary_writing question type) -->
          <div id="summaryWritingContainer" class="hidden">
            <label class="block text-sm font-medium text-gray-700 mb-2">Write your summary:</label>
            <textarea id="summaryText" rows="12" placeholder="Write your summary here..."
                      class="w-full px-4 py-3 border-2 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 resize-y"
                      oninput="autoSaveSummary()"></textarea>
            <div class="flex justify-between items-center mt-2">
              <div class="flex space-x-4">
                <p class="text-xs text-gray-400" id="wordCount">0 words</p>
                <p class="text-xs" id="wordLimitInfo"></p>
              </div>
              <p class="text-xs text-green-600 hidden" id="summarySaveIndicator">Saved</p>
            </div>
          </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="flex items-center justify-between">
          <div class="flex space-x-2">
            <button onclick="markForReview()" id="reviewBtn"
                    class="px-4 py-2 bg-amber-100 text-amber-700 rounded-lg text-sm font-medium hover:bg-amber-200 transition cursor-pointer">
              Mark for Review
            </button>
            <button onclick="clearAnswer()"
                    class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg text-sm font-medium hover:bg-gray-200 transition cursor-pointer">
              Clear Response
            </button>
          </div>
          <div class="flex space-x-2">
            <button onclick="prevQuestion()"
                    class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-300 transition cursor-pointer">
              &laquo; Previous
            </button>
            <button onclick="nextQuestion()"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition cursor-pointer">
              Next &raquo;
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Sidebar -->
    <div class="w-72 bg-white border-l overflow-y-auto flex flex-col">
      <!-- Webcam Feed -->
      <div class="p-3 border-b">
        <div class="bg-gray-900 rounded-lg overflow-hidden relative" style="height: 120px">
          <video id="proctorCam" autoplay playsinline muted class="w-full h-full object-cover"></video>
          <canvas id="faceDetectCanvas" class="hidden"></canvas>
          <div class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full pulse"></div>
          <div class="absolute bottom-1 left-1 text-xs text-white bg-black/50 px-1.5 py-0.5 rounded">LIVE</div>
          <!-- Face warning overlay -->
          <div id="faceWarningBanner" class="hidden absolute inset-0 bg-red-600/80 flex items-center justify-center">
            <p id="faceWarningText" class="text-white text-xs font-bold text-center px-2"></p>
          </div>
        </div>
      </div>

      <!-- Question Navigation Panel -->
      <div class="p-3 border-b">
        <h3 class="font-semibold text-gray-800 text-sm mb-2">Question Navigation</h3>
        <div class="grid grid-cols-5 gap-1.5" id="questionNav">
          <% for (let i = 0; i < questions.length; i++) { %>
            <button onclick="goToQuestion(<%= i %>)"
                    class="w-9 h-9 rounded-lg text-xs font-medium border transition cursor-pointer question-nav-btn"
                    data-index="<%= i %>" id="navBtn<%= i %>">
              <%= i + 1 %>
            </button>
          <% } %>
        </div>

        <!-- Legend -->
        <div class="flex flex-wrap gap-2 mt-3 text-xs">
          <div class="flex items-center space-x-1">
            <div class="w-3 h-3 rounded bg-green-500"></div><span class="text-gray-500">Answered</span>
          </div>
          <div class="flex items-center space-x-1">
            <div class="w-3 h-3 rounded bg-gray-200 border"></div><span class="text-gray-500">Not Answered</span>
          </div>
          <div class="flex items-center space-x-1">
            <div class="w-3 h-3 rounded bg-amber-400"></div><span class="text-gray-500">Review</span>
          </div>
          <div class="flex items-center space-x-1">
            <div class="w-3 h-3 rounded bg-indigo-500"></div><span class="text-gray-500">Current</span>
          </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="p-3 border-b">
        <h3 class="font-semibold text-gray-800 text-sm mb-2">Progress</h3>
        <div class="space-y-1.5 text-sm">
          <div class="flex justify-between"><span class="text-gray-500">Total Questions</span><span class="font-medium" id="statTotal"><%= questions.length %></span></div>
          <div class="flex justify-between"><span class="text-gray-500">Answered</span><span class="font-medium text-green-600" id="statAnswered">0</span></div>
          <div class="flex justify-between"><span class="text-gray-500">Not Answered</span><span class="font-medium text-gray-600" id="statPending"><%= questions.length %></span></div>
          <div class="flex justify-between"><span class="text-gray-500">Marked for Review</span><span class="font-medium text-amber-600" id="statReview">0</span></div>
        </div>
      </div>

      <!-- Violation Summary -->
      <div class="p-3 border-b">
        <h3 class="font-semibold text-gray-800 text-sm mb-2">Violation Summary</h3>
        <div class="space-y-1.5 text-sm">
          <div class="flex justify-between items-center">
            <span class="text-gray-500">Tab Switch</span>
            <span class="font-medium violation-count" id="vTabSwitch" data-count="<%= violationMap.tab_switch || 0 %>"><%= violationMap.tab_switch || 0 %></span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-500">Copy</span>
            <span class="font-medium violation-count" id="vCopy" data-count="<%= violationMap.copy || 0 %>"><%= violationMap.copy || 0 %></span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-500">Paste</span>
            <span class="font-medium violation-count" id="vPaste" data-count="<%= violationMap.paste || 0 %>"><%= violationMap.paste || 0 %></span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-500">Face Not Visible</span>
            <span class="font-medium violation-count" id="vFaceNotVisible" data-count="<%= violationMap.face_not_visible || 0 %>"><%= violationMap.face_not_visible || 0 %></span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-500">Multiple Faces</span>
            <span class="font-medium violation-count" id="vMultipleFaces" data-count="<%= violationMap.multiple_faces || 0 %>"><%= violationMap.multiple_faces || 0 %></span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-gray-500">Other Alerts</span>
            <span class="font-medium violation-count" id="vOther" data-count="0">0</span>
          </div>
        </div>
        <!-- Risk Indicator -->
        <div class="mt-3">
          <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
            <div id="riskBar" class="h-full bg-green-500 rounded-full transition-all duration-500" style="width: 0%"></div>
          </div>
          <p class="text-xs text-center mt-1" id="riskLabel">
            <span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-1"></span>Safe
          </p>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="p-3 mt-auto">
        <button onclick="submitExam(false)"
                class="w-full py-2.5 bg-red-600 text-white rounded-lg font-semibold text-sm hover:bg-red-700 transition cursor-pointer">
          Submit Exam
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Warning Modal -->
<div id="warningModal" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center">
  <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm mx-4 text-center">
    <div class="w-14 h-14 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
      <svg class="w-7 h-7 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
    </div>
    <h3 class="font-bold text-gray-800 text-lg mb-2" id="warningTitle">Warning!</h3>
    <p class="text-gray-600 text-sm mb-4" id="warningMessage">A violation has been detected.</p>
    <button onclick="dismissWarning()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition cursor-pointer">
      I Understand
    </button>
  </div>
</div>

<!-- Submit Confirmation Modal -->
<div id="submitModal" class="hidden fixed inset-0 bg-black/50 z-[100] flex items-center justify-center">
  <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm mx-4 text-center">
    <h3 class="font-bold text-gray-800 text-lg mb-2">Submit Examination?</h3>
    <p class="text-gray-600 text-sm mb-4" id="submitSummary">Are you sure you want to submit?</p>
    <div class="flex space-x-3 justify-center">
      <button onclick="closeSubmitModal()" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition cursor-pointer">
        Cancel
      </button>
      <button onclick="confirmSubmit()" class="px-6 py-2 bg-red-600 text-white rounded-lg font-medium hover:bg-red-700 transition cursor-pointer">
        Confirm Submit
      </button>
    </div>
  </div>
</div>

<script>
// ==================== DATA ====================
const questions = <%- JSON.stringify(questions) %>;
const existingResponses = <%- JSON.stringify(responses) %>;
const maxTabSwitches = <%= session.max_tab_switches %>;
const maxViolations = <%= session.max_violations %>;
const autoSaveInterval = <%= session.auto_save_interval || 15 %> * 1000;
let remainingSeconds = <%= remainingSeconds %>;
let currentIndex = 0;
let answers = {};          // { questionId: selectedOption }
let textAnswers = {};      // { questionId: answerText }
let fileAnswers = {};      // { questionId: { url, fileName } }
let reviewed = {};         // { questionId: true }
let longAnswerTimer = null;
let summaryTimer = null;

// Load existing responses
existingResponses.forEach(r => {
  if (r.selected_option) answers[r.question_id] = r.selected_option;
  if (r.answer_text) textAnswers[r.question_id] = r.answer_text;
  if (r.uploaded_file_url) fileAnswers[r.question_id] = { url: r.uploaded_file_url, fileName: r.uploaded_file_url.split('/').pop() };
  if (r.marked_for_review) reviewed[r.question_id] = true;
});

// ==================== TIMER ====================
function updateTimerDisplay() {
  const min = Math.floor(remainingSeconds / 60);
  const sec = remainingSeconds % 60;
  document.getElementById('timer').textContent =
    String(min).padStart(2, '0') + ':' + String(sec).padStart(2, '0');

  if (remainingSeconds <= 300) {
    document.getElementById('timerDisplay').className = 'bg-red-100 border border-red-300 rounded-lg px-4 py-1.5 flex items-center space-x-2';
  }
  if (remainingSeconds <= 0) {
    submitExam(true);
  }
}

setInterval(() => {
  if (remainingSeconds > 0) {
    remainingSeconds--;
    updateTimerDisplay();
  }
}, 1000);
updateTimerDisplay();

// Save time to server periodically
setInterval(() => {
  fetch('/api/save-time', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ time_remaining: remainingSeconds })
  });
}, autoSaveInterval);

// ==================== QUESTIONS ====================
function renderQuestion() {
  const q = questions[currentIndex];
  document.getElementById('questionSection').textContent = q.section_title || 'General';
  document.getElementById('questionNumber').textContent = `Question ${currentIndex + 1} of ${questions.length}`;
  document.getElementById('questionText').textContent = q.question_text;

  // Show question image if present
  const imgContainer = document.getElementById('questionImageContainer');
  const imgEl = document.getElementById('questionImage');
  if (q.question_image) {
    imgEl.src = q.question_image;
    imgContainer.classList.remove('hidden');
  } else {
    imgContainer.classList.add('hidden');
    imgEl.src = '';
  }

  const qType = q.question_type;
  const optionsContainer = document.getElementById('optionsContainer');
  const longAnswerContainer = document.getElementById('longAnswerContainer');
  const fileUploadContainer = document.getElementById('fileUploadContainer');
  const summaryWritingContainer = document.getElementById('summaryWritingContainer');

  // Hide all containers first
  optionsContainer.classList.add('hidden');
  longAnswerContainer.classList.add('hidden');
  fileUploadContainer.classList.add('hidden');
  summaryWritingContainer.classList.add('hidden');

  if (qType === 'file_upload') {
    fileUploadContainer.classList.remove('hidden');
    // Show constraints
    const allowedTypes = (q.allowed_file_types || 'pdf,jpg,jpeg,png').toUpperCase().split(',').join(', ');
    const maxSize = q.max_file_size_mb || 10;
    document.getElementById('fileConstraints').textContent = `Accepted: ${allowedTypes} | Max: ${maxSize}MB`;
    // Set accept attribute on file input
    const exts = (q.allowed_file_types || 'pdf,jpg,jpeg,png').split(',').map(e => '.' + e.trim()).join(',');
    document.getElementById('fileInput').setAttribute('accept', exts);
    // Show uploaded file if exists
    if (fileAnswers[q.id]) {
      document.getElementById('uploadedFileName').textContent = fileAnswers[q.id].fileName;
      document.getElementById('uploadedFileInfo').classList.remove('hidden');
      document.getElementById('fileDropZone').classList.add('hidden');
    } else {
      document.getElementById('uploadedFileInfo').classList.add('hidden');
      document.getElementById('fileDropZone').classList.remove('hidden');
    }
    document.getElementById('uploadProgress').classList.add('hidden');

  } else if (qType === 'summary_writing') {
    summaryWritingContainer.classList.remove('hidden');
    const textarea = document.getElementById('summaryText');
    textarea.value = textAnswers[q.id] || '';
    updateWordCount(textAnswers[q.id] || '', q);

  } else if (qType === 'descriptive') {
    longAnswerContainer.classList.remove('hidden');
    const textarea = document.getElementById('longAnswerText');
    textarea.value = textAnswers[q.id] || '';
    document.getElementById('charCount').textContent = (textAnswers[q.id] || '').length + ' characters';

  } else {
    // MCQ and other option-based types
    optionsContainer.classList.remove('hidden');

    const opts = [
      { key: 'A', text: q.option_a },
      { key: 'B', text: q.option_b },
      { key: 'C', text: q.option_c },
      { key: 'D', text: q.option_d }
    ];

    optionsContainer.innerHTML = '';
    opts.forEach(opt => {
      if (!opt.text) return;
      const selected = answers[q.id] === opt.key;
      const div = document.createElement('div');
      div.className = `p-4 border-2 rounded-xl cursor-pointer transition hover:border-indigo-300 ${selected ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200'}`;
      div.onclick = () => selectOption(q.id, opt.key);
      div.innerHTML = `
        <div class="flex items-center space-x-3">
          <div class="w-8 h-8 rounded-full border-2 flex items-center justify-center text-sm font-bold ${selected ? 'border-indigo-500 bg-indigo-500 text-white' : 'border-gray-300 text-gray-500'}">
            ${opt.key}
          </div>
          <span class="${selected ? 'text-indigo-700 font-medium' : 'text-gray-700'}">${opt.text}</span>
        </div>
      `;
      optionsContainer.appendChild(div);
    });
  }

  // Update review button
  document.getElementById('reviewBtn').textContent = reviewed[q.id] ? 'Remove Review Mark' : 'Mark for Review';

  updateNavigation();
  updateStats();
}

function selectOption(qId, option) {
  answers[qId] = option;
  renderQuestion();
  saveAnswer(qId, option, null, !!reviewed[qId]);
}

function clearAnswer() {
  const q = questions[currentIndex];
  delete answers[q.id];
  delete textAnswers[q.id];
  delete fileAnswers[q.id];
  renderQuestion();
  saveAnswer(q.id, null, null, !!reviewed[q.id]);
}

function autoSaveLongAnswer() {
  const q = questions[currentIndex];
  const text = document.getElementById('longAnswerText').value;
  textAnswers[q.id] = text;
  document.getElementById('charCount').textContent = text.length + ' characters';

  clearTimeout(longAnswerTimer);
  longAnswerTimer = setTimeout(() => {
    saveAnswer(q.id, null, text, !!reviewed[q.id]);
    const indicator = document.getElementById('saveIndicator');
    indicator.classList.remove('hidden');
    setTimeout(() => indicator.classList.add('hidden'), 2000);
  }, 1000);
}

function markForReview() {
  const q = questions[currentIndex];
  if (reviewed[q.id]) {
    delete reviewed[q.id];
  } else {
    reviewed[q.id] = true;
  }
  renderQuestion();
  saveAnswer(q.id, answers[q.id] || null, textAnswers[q.id] || null, !!reviewed[q.id]);
}

function nextQuestion() {
  if (currentIndex < questions.length - 1) {
    currentIndex++;
    renderQuestion();
  }
}

function prevQuestion() {
  if (currentIndex > 0) {
    currentIndex--;
    renderQuestion();
  }
}

function goToQuestion(idx) {
  currentIndex = idx;
  renderQuestion();
}

function updateNavigation() {
  document.querySelectorAll('.question-nav-btn').forEach((btn, i) => {
    const q = questions[i];
    const hasAnswer = answers[q.id] || (textAnswers[q.id] && textAnswers[q.id].trim().length > 0) || fileAnswers[q.id];
    let cls = 'w-9 h-9 rounded-lg text-xs font-medium border transition cursor-pointer question-nav-btn ';
    if (i === currentIndex) {
      cls += 'bg-indigo-500 text-white border-indigo-500';
    } else if (reviewed[q.id]) {
      cls += 'bg-amber-400 text-white border-amber-400';
    } else if (hasAnswer) {
      cls += 'bg-green-500 text-white border-green-500';
    } else {
      cls += 'bg-gray-100 text-gray-600 border-gray-200 hover:bg-gray-200';
    }
    btn.className = cls;
  });
}

function updateStats() {
  const answeredSet = new Set([...Object.keys(answers)]);
  Object.keys(textAnswers).forEach(qId => {
    if (textAnswers[qId] && textAnswers[qId].trim().length > 0) answeredSet.add(qId);
  });
  Object.keys(fileAnswers).forEach(qId => answeredSet.add(qId));
  const answered = answeredSet.size;
  const reviewCount = Object.keys(reviewed).length;
  document.getElementById('statAnswered').textContent = answered;
  document.getElementById('statPending').textContent = questions.length - answered;
  document.getElementById('statReview').textContent = reviewCount;
}

// Save answer to server
function saveAnswer(qId, option, answerText, review) {
  fetch('/api/save-answer', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ question_id: qId, selected_option: option, answer_text: answerText, marked_for_review: review })
  });
}

// ==================== FILE UPLOAD ====================
function handleFileDrop(e) {
  e.preventDefault();
  e.currentTarget.classList.remove('border-indigo-500', 'bg-indigo-50');
  const file = e.dataTransfer.files[0];
  if (file) handleFileSelect(file);
}

function handleFileSelect(file) {
  const q = questions[currentIndex];
  if (!file) return;

  // Validate file type
  const allowedTypes = (q.allowed_file_types || 'pdf,jpg,jpeg,png').split(',').map(t => t.trim().toLowerCase());
  const ext = file.name.split('.').pop().toLowerCase();
  if (!allowedTypes.includes(ext)) {
    alert('File type not allowed. Accepted: ' + allowedTypes.join(', ').toUpperCase());
    return;
  }

  // Validate file size
  const maxSize = (q.max_file_size_mb || 10) * 1024 * 1024;
  if (file.size > maxSize) {
    alert('File too large. Maximum: ' + (q.max_file_size_mb || 10) + 'MB');
    return;
  }

  uploadFile(q.id, file);
}

async function uploadFile(qId, file) {
  const progress = document.getElementById('uploadProgress');
  const progressBar = document.getElementById('uploadProgressBar');
  const progressText = document.getElementById('uploadProgressText');
  const dropZone = document.getElementById('fileDropZone');

  progress.classList.remove('hidden');
  dropZone.classList.add('hidden');
  progressBar.style.width = '0%';
  progressText.textContent = 'Uploading...';

  const fd = new FormData();
  fd.append('response_file', file);
  fd.append('question_id', qId);

  try {
    const xhr = new XMLHttpRequest();
    xhr.upload.addEventListener('progress', (e) => {
      if (e.lengthComputable) {
        const pct = Math.round((e.loaded / e.total) * 100);
        progressBar.style.width = pct + '%';
        progressText.textContent = pct + '%';
      }
    });

    const result = await new Promise((resolve, reject) => {
      xhr.onload = () => resolve(JSON.parse(xhr.responseText));
      xhr.onerror = () => reject(new Error('Upload failed'));
      xhr.open('POST', '/api/upload-response');
      xhr.send(fd);
    });

    if (result.success) {
      fileAnswers[qId] = { url: result.fileUrl, fileName: result.fileName };
      progress.classList.add('hidden');
      document.getElementById('uploadedFileName').textContent = result.fileName;
      document.getElementById('uploadedFileInfo').classList.remove('hidden');
      updateNavigation();
      updateStats();
    } else {
      progress.classList.add('hidden');
      dropZone.classList.remove('hidden');
      alert(result.error || 'Upload failed');
    }
  } catch (err) {
    progress.classList.add('hidden');
    dropZone.classList.remove('hidden');
    alert('Upload failed. Please try again.');
  }
}

function removeUploadedFile() {
  const q = questions[currentIndex];
  delete fileAnswers[q.id];
  document.getElementById('uploadedFileInfo').classList.add('hidden');
  document.getElementById('fileDropZone').classList.remove('hidden');
  document.getElementById('fileInput').value = '';
  saveAnswer(q.id, null, null, !!reviewed[q.id]);
  updateNavigation();
  updateStats();
}

// ==================== SUMMARY WRITING ====================
function updateWordCount(text, q) {
  const words = text.trim() ? text.trim().split(/\s+/).length : 0;
  const countEl = document.getElementById('wordCount');
  const limitEl = document.getElementById('wordLimitInfo');
  countEl.textContent = words + ' word' + (words !== 1 ? 's' : '');

  const minW = q.min_word_count || 0;
  const maxW = q.max_word_count || 0;

  if (minW > 0 && maxW > 0) {
    limitEl.textContent = `(Required: ${minW} - ${maxW} words)`;
    limitEl.className = 'text-xs ' + (words >= minW && words <= maxW ? 'text-green-600' : 'text-red-500');
  } else if (minW > 0) {
    limitEl.textContent = `(Minimum: ${minW} words)`;
    limitEl.className = 'text-xs ' + (words >= minW ? 'text-green-600' : 'text-red-500');
  } else if (maxW > 0) {
    limitEl.textContent = `(Maximum: ${maxW} words)`;
    limitEl.className = 'text-xs ' + (words <= maxW ? 'text-green-600' : 'text-red-500');
  } else {
    limitEl.textContent = '';
  }
}

function autoSaveSummary() {
  const q = questions[currentIndex];
  const text = document.getElementById('summaryText').value;
  textAnswers[q.id] = text;
  updateWordCount(text, q);

  clearTimeout(summaryTimer);
  summaryTimer = setTimeout(() => {
    saveAnswer(q.id, null, text, !!reviewed[q.id]);
    const indicator = document.getElementById('summarySaveIndicator');
    indicator.classList.remove('hidden');
    setTimeout(() => indicator.classList.add('hidden'), 2000);
  }, 1000);
}

// ==================== PROCTORING ====================
let totalViolations = 0;
let faceDetector = null;
let faceCheckInterval = null;
let lastFaceWarningType = null; // track current warning to avoid spamming violations
let faceWarningStartTime = null; // when the current warning began
const FACE_CHECK_INTERVAL = 2000; // check every 2 seconds
const FACE_VIOLATION_DELAY = 4000; // log violation after 4 seconds of continuous issue

// Skin tone detection using YCbCr color space - works across all skin tones
function isSkinPixel(r, g, b) {
  const y  = 0.299 * r + 0.587 * g + 0.114 * b;
  const cb = 128 - 0.169 * r - 0.331 * g + 0.500 * b;
  const cr = 128 + 0.500 * r - 0.419 * g - 0.081 * b;
  return y > 60 && cb > 77 && cb < 127 && cr > 133 && cr < 173;
}

// Analyze canvas for face presence using skin tone detection
function detectSkinInFrame(canvas) {
  const ctx = canvas.getContext('2d');
  const w = canvas.width;
  const h = canvas.height;
  if (w === 0 || h === 0) return { hasFace: false, skinRatio: 0 };

  const imageData = ctx.getImageData(0, 0, w, h);
  const data = imageData.data;

  // Check center region of frame where face should be
  const centerX = w / 2;
  const centerY = h * 0.45;
  const regionW = w * 0.5;
  const regionH = h * 0.7;

  let skinPixels = 0;
  let totalPixels = 0;

  const step = 4;
  const startY = Math.max(0, Math.floor(centerY - regionH / 2));
  const endY = Math.min(h, Math.floor(centerY + regionH / 2));
  const startX = Math.max(0, Math.floor(centerX - regionW / 2));
  const endX = Math.min(w, Math.floor(centerX + regionW / 2));

  for (let py = startY; py < endY; py += step) {
    for (let px = startX; px < endX; px += step) {
      const idx = (py * w + px) * 4;
      totalPixels++;
      if (isSkinPixel(data[idx], data[idx + 1], data[idx + 2])) skinPixels++;
    }
  }

  const skinRatio = totalPixels > 0 ? skinPixels / totalPixels : 0;
  return { hasFace: skinRatio >= 0.12, skinRatio };
}

// Run face check on current video frame
async function checkFaceInFrame() {
  const video = document.getElementById('proctorCam');
  if (!video || video.readyState < 2) return;

  const canvas = document.getElementById('faceDetectCanvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);

  const banner = document.getElementById('faceWarningBanner');
  const bannerText = document.getElementById('faceWarningText');

  // Try browser FaceDetector API first (more accurate)
  if (faceDetector) {
    try {
      const faces = await faceDetector.detect(canvas);
      if (faces.length === 0) {
        showFaceWarning('no_face', 'NO FACE DETECTED!\nPlease stay visible in the camera.');
        return;
      }
      if (faces.length > 1) {
        showFaceWarning('multiple_faces', 'MULTIPLE FACES DETECTED!\nOnly the exam taker should be visible.');
        return;
      }
      // Single face detected - all good
      clearFaceWarning();
      return;
    } catch (e) {
      // FaceDetector failed, fall through to skin detection
    }
  }

  // Fallback: skin tone detection
  const result = detectSkinInFrame(canvas);
  if (!result.hasFace) {
    showFaceWarning('no_face', 'NO FACE DETECTED!\nPlease stay visible in the camera.');
  } else {
    clearFaceWarning();
  }
}

function showFaceWarning(type, message) {
  const banner = document.getElementById('faceWarningBanner');
  const bannerText = document.getElementById('faceWarningText');

  banner.classList.remove('hidden');
  bannerText.textContent = message;

  if (lastFaceWarningType === type) {
    // Same warning continuing - check if enough time has passed to log violation
    if (faceWarningStartTime && (Date.now() - faceWarningStartTime >= FACE_VIOLATION_DELAY)) {
      const violationType = type === 'multiple_faces' ? 'multiple_faces' : 'face_not_visible';
      logViolation(violationType, type === 'multiple_faces'
        ? 'Multiple faces detected during exam'
        : 'Student face not visible in camera');
      showWarning(
        type === 'multiple_faces' ? 'Multiple Faces Detected' : 'Face Not Visible',
        type === 'multiple_faces'
          ? 'More than one person was detected in the camera. Only the exam taker should be visible. This has been recorded as a violation.'
          : 'Your face is not visible in the camera. Please make sure you are properly positioned in front of the camera. This has been recorded as a violation.'
      );
      // Reset timer so next violation requires another sustained period
      faceWarningStartTime = Date.now();
    }
  } else {
    // New warning type - start tracking
    lastFaceWarningType = type;
    faceWarningStartTime = Date.now();
  }
}

function clearFaceWarning() {
  const banner = document.getElementById('faceWarningBanner');
  banner.classList.add('hidden');
  lastFaceWarningType = null;
  faceWarningStartTime = null;
}

// Initialize webcam for proctoring with face detection
(async function initProctoring() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    document.getElementById('proctorCam').srcObject = stream;

    // Initialize FaceDetector if available
    if (window.FaceDetector) {
      faceDetector = new FaceDetector({ fastMode: true, maxDetectedFaces: 5 });
    }

    // Start continuous face monitoring after video is ready
    const video = document.getElementById('proctorCam');
    video.addEventListener('loadeddata', () => {
      faceCheckInterval = setInterval(checkFaceInFrame, FACE_CHECK_INTERVAL);
    });
  } catch (err) {
    console.error('Proctor cam error:', err);
  }
})();

// Enter fullscreen
function requestFullscreen() {
  const el = document.documentElement;
  if (el.requestFullscreen) el.requestFullscreen();
  else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen();
  else if (el.msRequestFullscreen) el.msRequestFullscreen();
}
requestFullscreen();

// 1. Tab Switch Detection
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    logViolation('tab_switch', 'User switched tabs or minimized window');
  }
});

window.addEventListener('blur', () => {
  logViolation('tab_switch', 'Window lost focus');
});

// 2. Copy Detection
document.addEventListener('copy', (e) => {
  e.preventDefault();
  logViolation('copy', 'Copy attempt detected (Ctrl+C or context menu)');
});

// 3. Paste Detection
document.addEventListener('paste', (e) => {
  e.preventDefault();
  logViolation('paste', 'Paste attempt detected (Ctrl+V)');
});

// Disable right-click context menu
document.addEventListener('contextmenu', (e) => {
  e.preventDefault();
});

// Disable Ctrl+C, Ctrl+V, Ctrl+A
document.addEventListener('keydown', (e) => {
  if (e.ctrlKey && (e.key === 'c' || e.key === 'v' || e.key === 'a' || e.key === 'u')) {
    e.preventDefault();
    if (e.key === 'c') logViolation('copy', 'Ctrl+C keyboard shortcut');
    if (e.key === 'v') logViolation('paste', 'Ctrl+V keyboard shortcut');
  }
});

// 6. Fullscreen Detection
document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement) {
    logViolation('fullscreen_exit', 'Exited fullscreen mode');
    showWarning('Fullscreen Required', 'Please stay in fullscreen mode during the exam. Click the button below and press F11.');
  }
});

// 7. Inactivity Detection
let inactivityTimer;
function resetInactivity() {
  clearTimeout(inactivityTimer);
  inactivityTimer = setTimeout(() => {
    logViolation('inactivity', 'No activity detected for 60 seconds');
    showWarning('Inactivity Detected', 'No mouse or keyboard activity detected. Please continue your exam.');
  }, 60000);
}
document.addEventListener('mousemove', resetInactivity);
document.addEventListener('keypress', resetInactivity);
resetInactivity();

function logViolation(type, details) {
  fetch('/api/log-violation', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ type, details, severity: (type === 'tab_switch' || type === 'multiple_faces' || type === 'face_not_visible') ? 'high' : 'medium' })
  }).then(r => r.json()).then(data => {
    if (data.success) {
      totalViolations = data.totalViolations;
      updateViolationDisplay(type);
      if (data.shouldAutoSubmit) {
        submitExam(true);
      }
    }
  });

  fetch('/api/log-event', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ event_type: 'violation_' + type, event_data: { details } })
  });
}

function updateViolationDisplay(type) {
  const mapping = {
    'tab_switch': 'vTabSwitch',
    'copy': 'vCopy',
    'paste': 'vPaste',
    'face_not_visible': 'vFaceNotVisible',
    'multiple_faces': 'vMultipleFaces'
  };

  const id = mapping[type] || 'vOther';
  const el = document.getElementById(id);
  const current = parseInt(el.dataset.count || 0) + 1;
  el.dataset.count = current;
  el.textContent = current;
  el.className = 'font-medium violation-count ' + (current >= 3 ? 'text-red-600' : current >= 1 ? 'text-amber-600' : 'text-green-600');

  // Update risk bar
  const riskPct = Math.min(100, (totalViolations / maxViolations) * 100);
  const bar = document.getElementById('riskBar');
  bar.style.width = riskPct + '%';
  const label = document.getElementById('riskLabel');
  if (riskPct >= 70) {
    bar.className = 'h-full bg-red-500 rounded-full transition-all duration-500';
    label.innerHTML = '<span class="inline-block w-2 h-2 rounded-full bg-red-500 mr-1"></span>High Risk';
  } else if (riskPct >= 40) {
    bar.className = 'h-full bg-amber-500 rounded-full transition-all duration-500';
    label.innerHTML = '<span class="inline-block w-2 h-2 rounded-full bg-amber-500 mr-1"></span>Warning';
  } else {
    bar.className = 'h-full bg-green-500 rounded-full transition-all duration-500';
    label.innerHTML = '<span class="inline-block w-2 h-2 rounded-full bg-green-500 mr-1"></span>Safe';
  }
}

// ==================== WARNINGS & MODALS ====================
function showWarning(title, message) {
  document.getElementById('warningTitle').textContent = title;
  document.getElementById('warningMessage').textContent = message;
  document.getElementById('warningModal').classList.remove('hidden');
}

function dismissWarning() {
  document.getElementById('warningModal').classList.add('hidden');
  requestFullscreen();
}

function submitExam(auto) {
  if (auto) {
    confirmSubmitAction(true);
    return;
  }
  const answeredSet = new Set([...Object.keys(answers)]);
  Object.keys(textAnswers).forEach(qId => { if (textAnswers[qId] && textAnswers[qId].trim().length > 0) answeredSet.add(qId); });
  Object.keys(fileAnswers).forEach(qId => answeredSet.add(qId));
  document.getElementById('submitSummary').textContent =
    `You have answered ${answeredSet.size} out of ${questions.length} questions. This action cannot be undone.`;
  document.getElementById('submitModal').classList.remove('hidden');
}

function closeSubmitModal() {
  document.getElementById('submitModal').classList.add('hidden');
}

function confirmSubmit() {
  closeSubmitModal();
  confirmSubmitAction(false);
}

async function confirmSubmitAction(auto) {
  const res = await fetch('/exam/submit', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ auto })
  });
  const data = await res.json();
  if (data.success) {
    if (document.fullscreenElement) document.exitFullscreen();
    window.location.href = data.redirect;
  }
}

// ==================== INIT ====================
renderQuestion();
</script>

<%- include('../partials/footer') %>
