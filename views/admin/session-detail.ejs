<%- include('../partials/head', { title: 'Session Detail - Admin' }) %>

<div class="min-h-screen flex">
  <%- include('../partials/admin-sidebar') %>

  <div class="lg:ml-64 flex-1">
    <!-- Header -->
    <div class="bg-[var(--card)] border-b border-[var(--card-border)] px-4 sm:px-6 py-4">
      <div class="flex items-center space-x-2 text-sm text-surface-500 dark:text-surface-400 mb-1 ml-10 lg:ml-0">
        <a href="/admin/sessions" class="hover:text-primary-500 dark:hover:text-primary-400 transition">Sessions</a>
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
        <span class="text-surface-900 dark:text-surface-50">Session #<%= session.id %></span>
      </div>
      <h1 class="text-xl font-bold text-surface-900 dark:text-surface-50 ml-10 lg:ml-0">Session #<%= session.id %> - <%= session.student_name %></h1>
    </div>

    <div class="p-4 sm:p-6">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-6">
      <!-- Left Column -->
      <div class="space-y-4 sm:space-y-6">
        <div class="bg-[var(--card)] rounded-2xl shadow-sm border border-[var(--card-border)] p-5">
          <h3 class="font-bold text-surface-900 dark:text-surface-50 mb-3">Student Information</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-surface-500 dark:text-surface-400">Name</span><span class="font-medium text-surface-900 dark:text-surface-100"><%= session.student_name %></span></div>
            <div class="flex justify-between"><span class="text-surface-500 dark:text-surface-400">Application ID</span><span class="font-medium text-surface-900 dark:text-surface-100"><%= session.application_id %></span></div>
            <div class="flex justify-between"><span class="text-surface-500 dark:text-surface-400">Email</span><span class="font-medium text-surface-900 dark:text-surface-100"><%= session.email || 'N/A' %></span></div>
            <div class="flex justify-between"><span class="text-surface-500 dark:text-surface-400">Mobile</span><span class="font-medium text-surface-900 dark:text-surface-100"><%= session.mobile %></span></div>
          </div>
          <% if (session.base_photo_url) { %>
            <div class="mt-3">
              <p class="text-sm text-surface-500 dark:text-surface-400 mb-1">Base Photo:</p>
              <img src="<%= session.base_photo_url %>" class="w-24 h-24 rounded-xl object-cover border border-[var(--card-border)]">
            </div>
          <% } %>
        </div>

        <div class="bg-[var(--card)] rounded-2xl shadow-sm border border-[var(--card-border)] p-5">
          <h3 class="font-bold text-surface-900 dark:text-surface-50 mb-3">Session Details</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-surface-500 dark:text-surface-400">Exam</span><span class="font-medium text-surface-900 dark:text-surface-100"><%= session.exam_title %></span></div>
            <div class="flex justify-between"><span class="text-surface-500 dark:text-surface-400">Status</span>
              <span class="inline-flex px-2 py-0.5 rounded-full text-xs font-semibold
                <%= session.status === 'submitted' ? 'bg-green-50 dark:bg-green-900/20 text-green-700 dark:text-green-400' :
                   session.status === 'auto_submitted' ? 'bg-amber-50 dark:bg-amber-900/20 text-amber-700 dark:text-amber-400' :
                   session.status === 'disqualified' ? 'bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400' : 'bg-surface-100 dark:bg-surface-800 text-surface-600 dark:text-surface-400' %>">
                <%= session.status %>
              </span>
            </div>
            <div class="flex justify-between"><span class="text-surface-500 dark:text-surface-400">Duration</span><span class="font-medium text-surface-900 dark:text-surface-100"><%= session.duration_minutes %> min</span></div>
            <div class="flex justify-between"><span class="text-surface-500 dark:text-surface-400">IP Address</span><span class="font-medium text-surface-900 dark:text-surface-100"><%= session.ip_address || 'N/A' %></span></div>
            <div class="flex justify-between"><span class="text-surface-500 dark:text-surface-400">Screen</span><span class="font-medium text-surface-900 dark:text-surface-100"><%= session.screen_resolution || 'N/A' %></span></div>
            <div class="flex justify-between"><span class="text-surface-500 dark:text-surface-400">Started</span><span class="font-medium text-surface-900 dark:text-surface-100"><%= session.started_at ? new Date(session.started_at).toLocaleString() : 'N/A' %></span></div>
            <div class="flex justify-between"><span class="text-surface-500 dark:text-surface-400">Submitted</span><span class="font-medium text-surface-900 dark:text-surface-100"><%= session.submitted_at ? new Date(session.submitted_at).toLocaleString() : 'N/A' %></span></div>
          </div>
        </div>

        <div class="bg-[var(--card)] rounded-2xl shadow-sm border border-[var(--card-border)] p-5">
          <h3 class="font-bold text-surface-900 dark:text-surface-50 mb-3">Results</h3>
          <div class="space-y-2 text-sm">
            <div class="flex justify-between"><span class="text-surface-500 dark:text-surface-400">Total Answered</span><span class="font-medium text-surface-900 dark:text-surface-100"><%= session.total_answered || 0 %> / <%= session.total_questions %></span></div>
            <div class="flex justify-between"><span class="text-surface-500 dark:text-surface-400">Correct Answers</span><span class="font-medium text-accent-600 dark:text-accent-400"><%= session.correct_answers || 0 %></span></div>
            <div class="flex justify-between"><span class="text-surface-500 dark:text-surface-400">Score</span><span class="font-bold text-lg text-primary-500 dark:text-primary-400"><%= session.score || 0 %></span></div>
          </div>
          <div class="mt-4 space-y-2">
            <div>
              <div class="flex justify-between text-xs mb-1">
                <span class="text-surface-600 dark:text-surface-400">Risk Score</span>
                <span class="<%= session.risk_score >= 70 ? 'text-red-600 dark:text-red-400' : session.risk_score >= 40 ? 'text-amber-600 dark:text-amber-400' : 'text-accent-600 dark:text-accent-400' %>"><%= session.risk_score ? Number(session.risk_score).toFixed(1) : 0 %>%</span>
              </div>
              <div class="h-2 bg-surface-200 dark:bg-surface-700 rounded-full overflow-hidden">
                <div class="h-full rounded-full <%= session.risk_score >= 70 ? 'bg-red-500' : session.risk_score >= 40 ? 'bg-amber-500' : 'bg-accent-500' %>" style="width: <%= session.risk_score || 0 %>%"></div>
              </div>
            </div>
            <div>
              <div class="flex justify-between text-xs mb-1">
                <span class="text-surface-600 dark:text-surface-400">Confidence Score</span>
                <span class="text-primary-500 dark:text-primary-400"><%= session.confidence_score ? Number(session.confidence_score).toFixed(1) : 100 %>%</span>
              </div>
              <div class="h-2 bg-surface-200 dark:bg-surface-700 rounded-full overflow-hidden">
                <div class="h-full bg-primary-500 rounded-full" style="width: <%= session.confidence_score || 100 %>%"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Middle Column -->
      <div class="space-y-4 sm:space-y-6">
        <div class="bg-[var(--card)] rounded-2xl shadow-sm border border-[var(--card-border)] p-5">
          <h3 class="font-bold text-surface-900 dark:text-surface-50 mb-3">Violation Summary</h3>
          <div class="space-y-2">
            <% violationSummary.forEach(v => { %>
              <div class="flex items-center justify-between p-2 rounded-xl <%= v.count >= 5 ? 'bg-red-50 dark:bg-red-900/20' : v.count >= 2 ? 'bg-amber-50 dark:bg-amber-900/20' : 'bg-green-50 dark:bg-green-900/20' %>">
                <span class="text-sm font-medium capitalize text-surface-900 dark:text-surface-100"><%= v.type.replace('_', ' ') %></span>
                <span class="text-sm font-bold <%= v.count >= 5 ? 'text-red-600 dark:text-red-400' : v.count >= 2 ? 'text-amber-600 dark:text-amber-400' : 'text-accent-600 dark:text-accent-400' %>"><%= v.count %></span>
              </div>
            <% }) %>
            <% if (violationSummary.length === 0) { %>
              <p class="text-sm text-surface-400 text-center py-2">No violations recorded</p>
            <% } %>
          </div>
        </div>

        <div class="bg-[var(--card)] rounded-2xl shadow-sm border border-[var(--card-border)] p-5">
          <h3 class="font-bold text-surface-900 dark:text-surface-50 mb-3">Violation Timeline</h3>
          <div class="space-y-2 max-h-96 overflow-y-auto">
            <% violations.forEach(v => { %>
              <div class="flex items-start space-x-2 text-sm p-2 rounded-xl border-l-3
                   <%= v.severity === 'high' ? 'border-l-red-500 bg-red-50 dark:bg-red-900/20' : v.severity === 'medium' ? 'border-l-amber-500 bg-amber-50 dark:bg-amber-900/20' : 'border-l-surface-300 bg-surface-50 dark:bg-surface-800/50' %>">
                <div>
                  <p class="font-medium capitalize text-surface-900 dark:text-surface-100"><%= v.type.replace('_', ' ') %></p>
                  <p class="text-xs text-surface-500 dark:text-surface-400"><%= v.details || '' %></p>
                  <p class="text-xs text-surface-400 mt-0.5"><%= new Date(v.timestamp).toLocaleTimeString() %></p>
                </div>
              </div>
            <% }) %>
            <% if (violations.length === 0) { %>
              <p class="text-sm text-surface-400 text-center py-2">No violation logs</p>
            <% } %>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="space-y-4 sm:space-y-6">
        <div class="bg-[var(--card)] rounded-2xl shadow-sm border border-[var(--card-border)] p-5">
          <h3 class="font-bold text-surface-900 dark:text-surface-50 mb-3">Admin Actions</h3>
          <div class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-surface-700 dark:text-surface-300 mb-1">Decision</label>
              <select id="adminStatus" class="w-full px-3 py-2 bg-[var(--input-bg)] border border-[var(--input-border)] rounded-xl text-sm text-surface-900 dark:text-surface-100">
                <option value="pending" <%= session.admin_status === 'pending' ? 'selected' : '' %>>Pending Review</option>
                <option value="approved" <%= session.admin_status === 'approved' ? 'selected' : '' %>>Approve</option>
                <option value="flagged" <%= session.admin_status === 'flagged' ? 'selected' : '' %>>Flag for Review</option>
                <option value="disqualified" <%= session.admin_status === 'disqualified' ? 'selected' : '' %>>Disqualify</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-surface-700 dark:text-surface-300 mb-1">Notes</label>
              <textarea id="adminNotes" rows="3" class="w-full px-3 py-2 bg-[var(--input-bg)] border border-[var(--input-border)] rounded-xl text-sm text-surface-900 dark:text-surface-100" placeholder="Add review notes..."><%= session.admin_notes || '' %></textarea>
            </div>
            <button onclick="updateSession()" class="w-full py-2 bg-primary-900 dark:bg-primary-700 text-white rounded-xl font-medium text-sm hover:bg-primary-800 dark:hover:bg-primary-600 transition cursor-pointer">
              Save Decision
            </button>
          </div>
        </div>

        <div class="bg-[var(--card)] rounded-2xl shadow-sm border border-[var(--card-border)] p-5">
          <h3 class="font-bold text-surface-900 dark:text-surface-50 mb-3">Student Responses</h3>
          <div class="space-y-2 max-h-[600px] overflow-y-auto">
            <% responses.forEach((r, i) => { %>
              <% if (r.question_type === 'file_upload') { %>
                <div class="p-3 rounded-xl text-sm border bg-purple-50 dark:bg-purple-900/20 border-purple-200 dark:border-purple-800">
                  <div class="flex justify-between items-center">
                    <span class="font-medium text-surface-700 dark:text-surface-300">Q<%= i + 1 %></span>
                    <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-purple-100 dark:bg-purple-900/40 text-purple-700 dark:text-purple-400">File Upload</span>
                  </div>
                  <p class="text-xs text-surface-500 dark:text-surface-400 mt-0.5 mb-2"><%= r.question_text %></p>
                  <% if (r.uploaded_file_url) { %>
                    <a href="<%= r.uploaded_file_url %>" target="_blank" class="inline-flex items-center space-x-1 px-2 py-1 bg-[var(--card)] border border-purple-300 dark:border-purple-700 rounded-lg text-xs text-purple-700 dark:text-purple-400 hover:bg-purple-100 dark:hover:bg-purple-900/30 transition">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                      <span>View Uploaded File</span>
                    </a>
                  <% } else { %>
                    <p class="text-xs text-surface-400 italic">No file uploaded</p>
                  <% } %>
                </div>
              <% } else if (r.question_type === 'summary_writing') { %>
                <div class="p-3 rounded-xl text-sm border bg-primary-50 dark:bg-primary-900/20 border-primary-200 dark:border-primary-800">
                  <div class="flex justify-between items-center">
                    <span class="font-medium text-surface-700 dark:text-surface-300">Q<%= i + 1 %></span>
                    <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-primary-100 dark:bg-primary-900/40 text-primary-700 dark:text-primary-400">Summary Writing</span>
                  </div>
                  <p class="text-xs text-surface-500 dark:text-surface-400 mt-0.5 mb-2"><%= r.question_text %></p>
                  <% if (r.answer_text) { %>
                    <div class="bg-[var(--card)] rounded-lg p-2 border border-[var(--card-border)] text-xs text-surface-700 dark:text-surface-300 whitespace-pre-wrap max-h-40 overflow-y-auto"><%= r.answer_text %></div>
                    <p class="text-xs text-surface-400 mt-1"><%= r.answer_text.trim().split(/\s+/).length %> words</p>
                  <% } else { %>
                    <p class="text-xs text-surface-400 italic">No summary provided</p>
                  <% } %>
                </div>
              <% } else if (r.question_type === 'descriptive') { %>
                <div class="p-3 rounded-xl text-sm border bg-blue-50 dark:bg-blue-900/20 border-blue-200 dark:border-blue-800">
                  <div class="flex justify-between items-center">
                    <span class="font-medium text-surface-700 dark:text-surface-300">Q<%= i + 1 %></span>
                    <span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-400">Descriptive</span>
                  </div>
                  <p class="text-xs text-surface-500 dark:text-surface-400 mt-0.5 mb-2"><%= r.question_text %></p>
                  <% if (r.answer_text) { %>
                    <div class="bg-[var(--card)] rounded-lg p-2 border border-[var(--card-border)] text-xs text-surface-700 dark:text-surface-300 whitespace-pre-wrap max-h-40 overflow-y-auto"><%= r.answer_text %></div>
                  <% } else { %>
                    <p class="text-xs text-surface-400 italic">No answer provided</p>
                  <% } %>
                </div>
              <% } else { %>
                <div class="p-2 rounded-xl text-sm border <%= r.selected_option === r.correct_option ? 'bg-green-50 dark:bg-green-900/20 border-green-200 dark:border-green-800' : 'bg-red-50 dark:bg-red-900/20 border-red-200 dark:border-red-800' %>">
                  <div class="flex justify-between">
                    <span class="font-medium text-surface-700 dark:text-surface-300">Q<%= i + 1 %></span>
                    <span>
                      <span class="<%= r.selected_option === r.correct_option ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400' %> font-medium"><%= r.selected_option || '-' %></span>
                      <span class="text-surface-400"> / </span>
                      <span class="text-green-600 dark:text-green-400"><%= r.correct_option %></span>
                    </span>
                  </div>
                  <p class="text-xs text-surface-500 dark:text-surface-400 truncate mt-0.5"><%= r.question_text %></p>
                </div>
              <% } %>
            <% }) %>
            <% if (responses.length === 0) { %>
              <p class="text-sm text-surface-400 text-center py-2">No responses recorded</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
</div>

<script>
async function updateSession() {
  const status = document.getElementById('adminStatus').value;
  const notes = document.getElementById('adminNotes').value;
  const res = await fetch('/admin/session/<%= session.id %>/update', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ admin_status: status, admin_notes: notes })
  });
  const data = await res.json();
  if (data.success) {
    alert('Decision saved successfully!');
    window.location.reload();
  } else {
    alert('Failed to save decision');
  }
}
</script>

<%- include('../partials/footer') %>
