<%- include('../partials/head', { title: 'Question Papers - Admin' }) %>

<div class="min-h-screen bg-gray-50 flex">
  <%- include('../partials/admin-sidebar') %>

  <div class="ml-56 flex-1">
    <!-- Header -->
    <div class="bg-white border-b px-6 py-4 flex items-center justify-between">
      <div>
        <h1 class="text-xl font-bold text-gray-800">Question Papers</h1>
        <p class="text-sm text-gray-500">Configure exam papers, sections, and questions</p>
      </div>
      <button onclick="openCreateModal()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition cursor-pointer flex items-center space-x-1">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
        <span>Create New Paper</span>
      </button>
    </div>

    <div class="p-6">
      <!-- Exam Papers List -->
      <div class="space-y-4">
        <% exams.forEach(e => { %>
          <div class="bg-white rounded-xl shadow-sm border p-5 hover:shadow-md transition fade-in">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div class="flex items-center space-x-2 mb-1">
                  <% if (e.exam_code) { %>
                    <span class="inline-flex px-2 py-0.5 rounded text-xs font-mono font-medium bg-gray-100 text-gray-600"><%= e.exam_code %></span>
                  <% } %>
                  <% if (e.degree_name) { %>
                    <span class="inline-flex px-2 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-700"><%= e.degree_code %> - <%= e.degree_name %></span>
                  <% } %>
                  <span class="inline-flex px-2 py-0.5 rounded-full text-xs font-medium <%= e.is_active ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500' %>">
                    <%= e.is_active ? 'Active' : 'Inactive' %>
                  </span>
                </div>
                <h3 class="text-lg font-bold text-gray-800"><%= e.title %></h3>
                <% if (e.description) { %><p class="text-sm text-gray-500 mt-0.5"><%= e.description %></p><% } %>

                <div class="flex items-center flex-wrap gap-3 mt-3 text-xs text-gray-500">
                  <span class="flex items-center space-x-1">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                    <span><%= e.duration_minutes %> min</span>
                  </span>
                  <span class="flex items-center space-x-1">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2"/></svg>
                    <span><%= e.question_count || 0 %> questions</span>
                  </span>
                  <span><%= e.section_count || 0 %> sections</span>
                  <span><%= e.total_marks || 0 %> marks</span>
                  <span>Pass: <%= e.passing_marks || 0 %></span>
                  <% if (e.negative_marking) { %><span class="text-red-500">Negative: -<%= e.negative_mark_value %></span><% } %>
                  <% if (e.exam_date) { %><span>Date: <%= new Date(e.exam_date).toLocaleDateString() %></span><% } %>
                </div>
              </div>

              <div class="flex items-center space-x-2 ml-4">
                <a href="/admin/exams/<%= e.id %>/assignments" class="px-3 py-1.5 bg-green-50 text-green-600 rounded-lg text-sm font-medium hover:bg-green-100 transition flex items-center space-x-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                  <span>Assign</span>
                </a>
                <a href="/admin/exams/<%= e.id %>" class="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-medium hover:bg-indigo-100 transition">
                  Configure
                </a>
                <button onclick="deleteExam(<%= e.id %>, '<%= e.title.replace(/'/g, "\\'") %>')" class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition cursor-pointer">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                </button>
              </div>
            </div>
          </div>
        <% }) %>

        <% if (exams.length === 0) { %>
          <div class="bg-white rounded-xl shadow-sm border p-12 text-center">
            <svg class="w-12 h-12 text-gray-300 mx-auto mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
            <p class="text-gray-400 mb-3">No question papers created yet</p>
            <button onclick="openCreateModal()" class="text-indigo-600 text-sm font-medium hover:text-indigo-800 cursor-pointer">Create your first paper</button>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Create Exam Modal -->
<div id="examModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-y-auto py-8">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 p-6">
    <div class="flex items-center justify-between mb-5">
      <h2 class="text-lg font-bold text-gray-800">Create New Question Paper</h2>
      <button onclick="closeExamModal()" class="text-gray-400 hover:text-gray-600 cursor-pointer">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>

    <form id="examForm" class="space-y-4">
      <!-- Basic Info -->
      <div class="grid grid-cols-2 gap-4">
        <div class="col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-1">Paper Title *</label>
          <input type="text" id="examTitle" required placeholder="e.g. Design Aptitude Test 2024"
                 class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Paper Code</label>
          <input type="text" id="examCode" placeholder="e.g. DAT-2024-001"
                 class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Degree / Program</label>
          <select id="examDegree" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="">-- No Degree --</option>
            <% degrees.forEach(d => { %>
              <option value="<%= d.id %>"><%= d.code %> - <%= d.name %></option>
            <% }) %>
          </select>
        </div>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
        <textarea id="examDesc" rows="2" placeholder="Brief description..."
                  class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
      </div>

      <!-- Paper Configuration -->
      <div class="border-t pt-4">
        <h3 class="font-semibold text-gray-800 text-sm mb-3">Paper Configuration</h3>
        <div class="grid grid-cols-4 gap-3">
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Duration (min)</label>
            <input type="number" id="examDuration" value="60" min="5"
                   class="w-full px-3 py-2 border rounded-lg text-sm">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Total Marks</label>
            <input type="number" id="examTotalMarks" value="100" min="1"
                   class="w-full px-3 py-2 border rounded-lg text-sm">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Passing Marks</label>
            <input type="number" id="examPassMarks" value="40" min="0"
                   class="w-full px-3 py-2 border rounded-lg text-sm">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Auto-save (sec)</label>
            <input type="number" id="examAutoSave" value="15" min="5"
                   class="w-full px-3 py-2 border rounded-lg text-sm">
          </div>
        </div>
      </div>

      <!-- Proctoring & Scoring -->
      <div class="border-t pt-4">
        <h3 class="font-semibold text-gray-800 text-sm mb-3">Proctoring & Scoring</h3>
        <div class="grid grid-cols-4 gap-3">
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Max Tab Switches</label>
            <input type="number" id="examMaxTab" value="5" min="1"
                   class="w-full px-3 py-2 border rounded-lg text-sm">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Max Violations</label>
            <input type="number" id="examMaxViol" value="10" min="1"
                   class="w-full px-3 py-2 border rounded-lg text-sm">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Neg. Marking Value</label>
            <input type="number" id="examNegValue" value="0.25" step="0.05" min="0"
                   class="w-full px-3 py-2 border rounded-lg text-sm">
          </div>
        </div>
        <div class="flex flex-wrap gap-4 mt-3">
          <label class="flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="examNegMarking" class="w-4 h-4 text-indigo-600 rounded cursor-pointer">
            <span class="text-sm text-gray-700">Negative Marking</span>
          </label>
          <label class="flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="examShuffle" class="w-4 h-4 text-indigo-600 rounded cursor-pointer">
            <span class="text-sm text-gray-700">Shuffle Questions</span>
          </label>
          <label class="flex items-center space-x-2 cursor-pointer">
            <input type="checkbox" id="examShowResult" class="w-4 h-4 text-indigo-600 rounded cursor-pointer">
            <span class="text-sm text-gray-700">Show Result Immediately</span>
          </label>
        </div>
      </div>

      <!-- Schedule -->
      <div class="border-t pt-4">
        <h3 class="font-semibold text-gray-800 text-sm mb-3">Schedule (Optional)</h3>
        <div class="grid grid-cols-3 gap-3">
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Exam Date</label>
            <input type="date" id="examDate" class="w-full px-3 py-2 border rounded-lg text-sm">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Start Time</label>
            <input type="time" id="examStart" class="w-full px-3 py-2 border rounded-lg text-sm">
          </div>
          <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">End Time</label>
            <input type="time" id="examEnd" class="w-full px-3 py-2 border rounded-lg text-sm">
          </div>
        </div>
      </div>

      <div class="flex justify-end space-x-2 pt-2 border-t">
        <button type="button" onclick="closeExamModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition cursor-pointer">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition cursor-pointer">Create Paper</button>
      </div>
    </form>
  </div>
</div>

<script>
function openCreateModal() { document.getElementById('examModal').classList.remove('hidden'); }
function closeExamModal() { document.getElementById('examModal').classList.add('hidden'); }

document.getElementById('examForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = {
    title: document.getElementById('examTitle').value,
    exam_code: document.getElementById('examCode').value,
    description: document.getElementById('examDesc').value,
    degree_id: document.getElementById('examDegree').value || null,
    duration_minutes: parseInt(document.getElementById('examDuration').value),
    total_marks: parseInt(document.getElementById('examTotalMarks').value),
    passing_marks: parseInt(document.getElementById('examPassMarks').value),
    auto_save_interval: parseInt(document.getElementById('examAutoSave').value),
    max_tab_switches: parseInt(document.getElementById('examMaxTab').value),
    max_violations: parseInt(document.getElementById('examMaxViol').value),
    negative_marking: document.getElementById('examNegMarking').checked,
    negative_mark_value: parseFloat(document.getElementById('examNegValue').value),
    shuffle_questions: document.getElementById('examShuffle').checked,
    show_result_immediately: document.getElementById('examShowResult').checked,
    exam_date: document.getElementById('examDate').value || null,
    start_time: document.getElementById('examStart').value || null,
    end_time: document.getElementById('examEnd').value || null
  };
  const res = await fetch('/admin/exams/create', {
    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data)
  });
  const result = await res.json();
  if (result.success) window.location.href = '/admin/exams/' + result.examId;
  else alert(result.error || 'Failed to create paper');
});

async function deleteExam(id, title) {
  if (!confirm(`Delete "${title}" and all its sections/questions? This cannot be undone.`)) return;
  const res = await fetch(`/admin/exams/${id}/delete`, { method: 'POST' });
  const data = await res.json();
  if (data.success) window.location.reload();
  else alert(data.error || 'Failed to delete');
}
</script>

<%- include('../partials/footer') %>
