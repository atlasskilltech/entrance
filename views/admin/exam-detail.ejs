<%- include('../partials/head', { title: exam.title + ' - Paper Config' }) %>

<div class="min-h-screen bg-gray-50 flex">
  <%- include('../partials/admin-sidebar') %>

  <div class="ml-56 flex-1">
    <!-- Header -->
    <div class="bg-white border-b px-6 py-4">
      <div class="flex items-center space-x-2 text-sm text-gray-500 mb-1">
        <a href="/admin/exams" class="hover:text-indigo-600 transition">Question Papers</a>
        <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
        <span class="text-gray-800 font-medium"><%= exam.title %></span>
      </div>
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-xl font-bold text-gray-800"><%= exam.title %></h1>
          <div class="flex items-center space-x-3 mt-1 text-sm text-gray-500">
            <% if (exam.exam_code) { %><span class="font-mono bg-gray-100 px-1.5 py-0.5 rounded text-xs"><%= exam.exam_code %></span><% } %>
            <% if (exam.degree_name) { %><span class="text-indigo-600"><%= exam.degree_code %> - <%= exam.degree_name %></span><% } %>
            <span><%= exam.duration_minutes %> min</span>
            <span><%= exam.total_marks %> marks</span>
            <span>Pass: <%= exam.passing_marks %></span>
          </div>
        </div>
        <div class="flex space-x-2">
          <button onclick="openEditExamModal()" class="px-3 py-1.5 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition cursor-pointer">
            Edit Paper Settings
          </button>
          <a href="/admin/exams/<%= exam.id %>/questions/add" class="px-3 py-1.5 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition flex items-center space-x-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            <span>Add Question</span>
          </a>
        </div>
      </div>
    </div>

    <div class="p-6">
      <div class="grid grid-cols-3 gap-6">
        <!-- Left: Paper Summary -->
        <div class="col-span-2 space-y-6">
          <!-- Paper Config Summary -->
          <div class="bg-white rounded-xl shadow-sm border p-5">
            <h3 class="font-bold text-gray-800 mb-3">Paper Configuration</h3>
            <div class="grid grid-cols-4 gap-3">
              <div class="bg-gray-50 rounded-lg p-3 text-center">
                <p class="text-2xl font-bold text-indigo-600"><%= sections.length %></p>
                <p class="text-xs text-gray-500">Sections</p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 text-center">
                <p class="text-2xl font-bold text-indigo-600"><%= questions.length %></p>
                <p class="text-xs text-gray-500">Questions</p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 text-center">
                <p class="text-2xl font-bold text-indigo-600"><%= exam.total_marks %></p>
                <p class="text-xs text-gray-500">Total Marks</p>
              </div>
              <div class="bg-gray-50 rounded-lg p-3 text-center">
                <p class="text-2xl font-bold text-indigo-600"><%= exam.duration_minutes %></p>
                <p class="text-xs text-gray-500">Minutes</p>
              </div>
            </div>
            <div class="flex flex-wrap gap-2 mt-3 text-xs">
              <span class="px-2 py-1 rounded-full <%= exam.negative_marking ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-500' %>">
                Negative Marking: <%= exam.negative_marking ? 'Yes (-' + exam.negative_mark_value + ')' : 'No' %>
              </span>
              <span class="px-2 py-1 rounded-full <%= exam.shuffle_questions ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-500' %>">
                Shuffle: <%= exam.shuffle_questions ? 'Yes' : 'No' %>
              </span>
              <span class="px-2 py-1 rounded-full bg-gray-100 text-gray-500">
                Max Tab Switches: <%= exam.max_tab_switches %>
              </span>
              <span class="px-2 py-1 rounded-full bg-gray-100 text-gray-500">
                Max Violations: <%= exam.max_violations %>
              </span>
            </div>
          </div>

          <!-- Sections -->
          <div class="bg-white rounded-xl shadow-sm border">
            <div class="px-5 py-4 border-b flex items-center justify-between">
              <h3 class="font-bold text-gray-800">Sections</h3>
              <button onclick="openSectionModal()" class="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-medium hover:bg-indigo-100 transition cursor-pointer flex items-center space-x-1">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                <span>Add Section</span>
              </button>
            </div>

            <% if (sections.length === 0) { %>
              <div class="p-8 text-center">
                <p class="text-gray-400 text-sm mb-2">No sections configured yet</p>
                <button onclick="openSectionModal()" class="text-indigo-600 text-sm font-medium hover:text-indigo-800 cursor-pointer">Add your first section</button>
              </div>
            <% } %>

            <div class="divide-y">
              <% sections.forEach((s, idx) => { %>
                <div class="p-4 hover:bg-gray-50 transition">
                  <div class="flex items-start justify-between">
                    <div class="flex-1">
                      <div class="flex items-center space-x-2">
                        <span class="inline-flex w-6 h-6 bg-indigo-100 text-indigo-700 rounded-full items-center justify-center text-xs font-bold"><%= idx + 1 %></span>
                        <h4 class="font-semibold text-gray-800"><%= s.title %></h4>
                        <span class="inline-flex px-2 py-0.5 rounded-full text-xs font-medium bg-blue-50 text-blue-600 capitalize"><%= s.section_type.replace('_', ' ') %></span>
                        <% if (s.is_mandatory) { %><span class="inline-flex px-1.5 py-0.5 rounded text-xs font-medium bg-red-50 text-red-600">Mandatory</span><% } %>
                      </div>
                      <% if (s.description) { %><p class="text-xs text-gray-500 mt-1 ml-8"><%= s.description %></p><% } %>
                      <div class="flex items-center space-x-4 mt-2 ml-8 text-xs text-gray-500">
                        <span><%= s.num_questions %> questions configured</span>
                        <span><%= s.actual_questions %> questions added</span>
                        <span><%= s.marks_per_question %> mark<%= s.marks_per_question > 1 ? 's' : '' %> each</span>
                        <span class="font-medium text-gray-700">Total: <%= s.total_marks %> marks</span>
                        <% if (s.time_limit_minutes > 0) { %><span>Time: <%= s.time_limit_minutes %> min</span><% } %>
                      </div>
                      <!-- Show questions count status -->
                      <% if (s.actual_questions < s.num_questions) { %>
                        <p class="text-xs text-amber-600 mt-1 ml-8">
                          Need <%= s.num_questions - s.actual_questions %> more question<%= (s.num_questions - s.actual_questions) > 1 ? 's' : '' %>
                        </p>
                      <% } %>
                    </div>
                    <div class="flex items-center space-x-1">
                      <a href="/admin/exams/<%= exam.id %>/questions/add?section_id=<%= s.id %>" class="p-1.5 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded-lg transition" title="Add Question">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                      </a>
                      <button onclick='editSection(<%- JSON.stringify(s) %>)' class="p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition cursor-pointer" title="Edit">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                      </button>
                      <button onclick="deleteSection(<%= s.id %>, '<%= s.title.replace(/'/g, "\\'") %>')" class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition cursor-pointer" title="Delete">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                      </button>
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
          </div>

          <!-- Questions List -->
          <div class="bg-white rounded-xl shadow-sm border">
            <div class="px-5 py-4 border-b flex items-center justify-between">
              <h3 class="font-bold text-gray-800">Questions (<%= questions.length %>)</h3>
              <a href="/admin/exams/<%= exam.id %>/questions/add" class="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded-lg text-sm font-medium hover:bg-indigo-100 transition flex items-center space-x-1">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                <span>Add Question</span>
              </a>
            </div>

            <% if (questions.length === 0) { %>
              <div class="p-8 text-center">
                <p class="text-gray-400 text-sm mb-2">No questions added yet</p>
                <a href="/admin/exams/<%= exam.id %>/questions/add" class="text-indigo-600 text-sm font-medium hover:text-indigo-800">Add your first question</a>
              </div>
            <% } %>

            <div class="divide-y">
              <% questions.forEach((q, idx) => { %>
                <div class="p-4 hover:bg-gray-50 transition">
                  <div class="flex items-start justify-between">
                    <div class="flex-1">
                      <div class="flex items-center space-x-2 mb-1">
                        <span class="text-xs font-bold text-gray-400">Q<%= idx + 1 %></span>
                        <% if (q.section_title) { %><span class="text-xs text-indigo-600"><%= q.section_title %></span><% } %>
                        <span class="inline-flex px-1.5 py-0.5 rounded text-xs capitalize
                          <%= q.difficulty === 'easy' ? 'bg-green-50 text-green-600' : q.difficulty === 'hard' ? 'bg-red-50 text-red-600' : 'bg-amber-50 text-amber-600' %>">
                          <%= q.difficulty || 'medium' %>
                        </span>
                        <span class="text-xs text-gray-400 capitalize"><%= (q.question_type || 'mcq').replace('_', ' ') %></span>
                        <span class="text-xs text-gray-500"><%= q.marks %> mark<%= q.marks > 1 ? 's' : '' %></span>
                      </div>
                      <p class="text-sm text-gray-800 line-clamp-2"><%= q.question_text %></p>
                      <div class="flex items-center space-x-3 mt-1 text-xs text-gray-500">
                        <% if (q.option_a) { %><span class="<%= q.correct_option === 'A' ? 'text-green-600 font-medium' : '' %>">A: <%= q.option_a.substring(0, 30) %><%= q.option_a.length > 30 ? '...' : '' %></span><% } %>
                        <% if (q.option_b) { %><span class="<%= q.correct_option === 'B' ? 'text-green-600 font-medium' : '' %>">B: <%= q.option_b.substring(0, 30) %><%= q.option_b.length > 30 ? '...' : '' %></span><% } %>
                        <% if (q.option_c) { %><span class="<%= q.correct_option === 'C' ? 'text-green-600 font-medium' : '' %>">C: <%= q.option_c.substring(0, 30) %><%= q.option_c.length > 30 ? '...' : '' %></span><% } %>
                        <% if (q.option_d) { %><span class="<%= q.correct_option === 'D' ? 'text-green-600 font-medium' : '' %>">D: <%= q.option_d.substring(0, 30) %><%= q.option_d.length > 30 ? '...' : '' %></span><% } %>
                      </div>
                    </div>
                    <div class="flex items-center space-x-1 ml-3">
                      <a href="/admin/questions/<%= q.id %>/edit" class="p-1.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-lg transition" title="Edit">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                      </a>
                      <button onclick="deleteQuestion(<%= q.id %>)" class="p-1.5 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition cursor-pointer" title="Delete">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                      </button>
                    </div>
                  </div>
                </div>
              <% }) %>
            </div>
          </div>
        </div>

        <!-- Right: Quick Info -->
        <div class="space-y-6">
          <!-- Section Summary Card -->
          <div class="bg-white rounded-xl shadow-sm border p-5">
            <h3 class="font-bold text-gray-800 mb-3">Section Breakdown</h3>
            <% if (sections.length === 0) { %>
              <p class="text-sm text-gray-400">No sections yet</p>
            <% } else { %>
              <div class="space-y-3">
                <% sections.forEach((s, idx) => { %>
                  <div>
                    <div class="flex items-center justify-between text-sm mb-1">
                      <span class="font-medium text-gray-700 truncate"><%= s.title %></span>
                      <span class="text-gray-500"><%= s.actual_questions %>/<%= s.num_questions %></span>
                    </div>
                    <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                      <div class="h-full rounded-full transition-all duration-500
                        <%= s.actual_questions >= s.num_questions ? 'bg-green-500' : s.actual_questions > 0 ? 'bg-amber-400' : 'bg-gray-300' %>"
                        style="width: <%= s.num_questions > 0 ? Math.min(100, (s.actual_questions / s.num_questions) * 100) : 0 %>%">
                      </div>
                    </div>
                    <div class="flex items-center space-x-2 mt-0.5 text-xs text-gray-400">
                      <span class="capitalize"><%= s.section_type.replace('_', ' ') %></span>
                      <span><%= s.marks_per_question %>m each</span>
                      <span class="font-medium"><%= s.total_marks %> total</span>
                    </div>
                  </div>
                <% }) %>
              </div>
            <% } %>
          </div>

          <!-- Question Type Distribution -->
          <div class="bg-white rounded-xl shadow-sm border p-5">
            <h3 class="font-bold text-gray-800 mb-3">Question Types</h3>
            <%
              const typeCounts = {};
              const diffCounts = { easy: 0, medium: 0, hard: 0 };
              questions.forEach(q => {
                const t = (q.question_type || 'mcq').replace('_', ' ');
                typeCounts[t] = (typeCounts[t] || 0) + 1;
                diffCounts[q.difficulty || 'medium']++;
              });
            %>
            <% if (questions.length > 0) { %>
              <div class="space-y-2 text-sm mb-4">
                <% Object.entries(typeCounts).forEach(([type, count]) => { %>
                  <div class="flex justify-between">
                    <span class="text-gray-500 capitalize"><%= type %></span>
                    <span class="font-medium"><%= count %></span>
                  </div>
                <% }) %>
              </div>
              <h4 class="font-semibold text-gray-700 text-sm mb-2">Difficulty</h4>
              <div class="flex space-x-2">
                <span class="px-2 py-1 rounded-full text-xs bg-green-50 text-green-600">Easy: <%= diffCounts.easy %></span>
                <span class="px-2 py-1 rounded-full text-xs bg-amber-50 text-amber-600">Medium: <%= diffCounts.medium %></span>
                <span class="px-2 py-1 rounded-full text-xs bg-red-50 text-red-600">Hard: <%= diffCounts.hard %></span>
              </div>
            <% } else { %>
              <p class="text-sm text-gray-400">No questions yet</p>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Section Modal -->
<div id="sectionModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 p-6">
    <div class="flex items-center justify-between mb-5">
      <h2 class="text-lg font-bold text-gray-800" id="sectionModalTitle">Add Section</h2>
      <button onclick="closeSectionModal()" class="text-gray-400 hover:text-gray-600 cursor-pointer">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <form id="sectionForm" class="space-y-4">
      <input type="hidden" id="sectionId" value="">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Section Title *</label>
        <input type="text" id="sectionTitle" required placeholder="e.g. Section A - Visual Perception"
               class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Section Type *</label>
          <select id="sectionType" class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
            <option value="mcq">MCQ (Multiple Choice)</option>
            <option value="true_false">True / False</option>
            <option value="fill_blank">Fill in the Blank</option>
            <option value="descriptive">Descriptive</option>
            <option value="image_based">Image Based</option>
            <option value="matching">Matching</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Sort Order</label>
          <input type="number" id="sectionOrder" value="<%= sections.length + 1 %>" min="1"
                 class="w-full px-3 py-2 border rounded-lg text-sm">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
        <textarea id="sectionDesc" rows="2" placeholder="Instructions for this section..."
                  class="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
      </div>
      <div class="grid grid-cols-3 gap-3">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">No. of Questions *</label>
          <input type="number" id="sectionNumQ" value="10" min="1" required
                 class="w-full px-3 py-2 border rounded-lg text-sm" onchange="calcTotal()">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Marks per Question</label>
          <input type="number" id="sectionMarksPerQ" value="1" min="1"
                 class="w-full px-3 py-2 border rounded-lg text-sm" onchange="calcTotal()">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Total Marks</label>
          <input type="number" id="sectionTotalMarks" value="10" readonly
                 class="w-full px-3 py-2 border rounded-lg text-sm bg-gray-50">
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Time Limit (minutes, 0 = no limit)</label>
        <input type="number" id="sectionTime" value="0" min="0"
               class="w-full px-3 py-2 border rounded-lg text-sm">
      </div>
      <div class="flex space-x-4">
        <label class="flex items-center space-x-2 cursor-pointer">
          <input type="checkbox" id="sectionMandatory" checked class="w-4 h-4 text-indigo-600 rounded cursor-pointer">
          <span class="text-sm text-gray-700">Mandatory</span>
        </label>
        <label class="flex items-center space-x-2 cursor-pointer">
          <input type="checkbox" id="sectionShuffle" class="w-4 h-4 text-indigo-600 rounded cursor-pointer">
          <span class="text-sm text-gray-700">Shuffle Questions</span>
        </label>
      </div>
      <div class="flex justify-end space-x-2 pt-2">
        <button type="button" onclick="closeSectionModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition cursor-pointer">Cancel</button>
        <button type="submit" id="sectionSaveBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition cursor-pointer">Add Section</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Exam Modal -->
<div id="editExamModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center overflow-y-auto py-8">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 p-6">
    <div class="flex items-center justify-between mb-5">
      <h2 class="text-lg font-bold text-gray-800">Edit Paper Settings</h2>
      <button onclick="closeEditExamModal()" class="text-gray-400 hover:text-gray-600 cursor-pointer">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
      </button>
    </div>
    <form id="editExamForm" class="space-y-4">
      <div class="grid grid-cols-2 gap-4">
        <div class="col-span-2">
          <label class="block text-sm font-medium text-gray-700 mb-1">Paper Title *</label>
          <input type="text" id="eeTitle" required value="<%= exam.title %>" class="w-full px-3 py-2 border rounded-lg text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Paper Code</label>
          <input type="text" id="eeCode" value="<%= exam.exam_code || '' %>" class="w-full px-3 py-2 border rounded-lg text-sm">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Degree</label>
          <select id="eeDegree" class="w-full px-3 py-2 border rounded-lg text-sm">
            <option value="">-- No Degree --</option>
            <% degrees.forEach(d => { %>
              <option value="<%= d.id %>" <%= exam.degree_id == d.id ? 'selected' : '' %>><%= d.code %> - <%= d.name %></option>
            <% }) %>
          </select>
        </div>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
        <textarea id="eeDesc" rows="2" class="w-full px-3 py-2 border rounded-lg text-sm"><%= exam.description || '' %></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Instructions</label>
        <textarea id="eeInstructions" rows="3" class="w-full px-3 py-2 border rounded-lg text-sm"><%= exam.instructions || '' %></textarea>
      </div>
      <div class="grid grid-cols-4 gap-3">
        <div><label class="block text-xs font-medium text-gray-600 mb-1">Duration (min)</label><input type="number" id="eeDuration" value="<%= exam.duration_minutes %>" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
        <div><label class="block text-xs font-medium text-gray-600 mb-1">Passing Marks</label><input type="number" id="eePassMarks" value="<%= exam.passing_marks %>" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
        <div><label class="block text-xs font-medium text-gray-600 mb-1">Max Tab Sw.</label><input type="number" id="eeMaxTab" value="<%= exam.max_tab_switches %>" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
        <div><label class="block text-xs font-medium text-gray-600 mb-1">Max Violations</label><input type="number" id="eeMaxViol" value="<%= exam.max_violations %>" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
      </div>
      <div class="grid grid-cols-3 gap-3">
        <div><label class="block text-xs font-medium text-gray-600 mb-1">Neg. Mark Value</label><input type="number" id="eeNegVal" value="<%= exam.negative_mark_value %>" step="0.05" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
        <div><label class="block text-xs font-medium text-gray-600 mb-1">Auto-save (sec)</label><input type="number" id="eeAutoSave" value="<%= exam.auto_save_interval %>" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
      </div>
      <div class="flex flex-wrap gap-4">
        <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="eeNeg" <%= exam.negative_marking ? 'checked' : '' %> class="w-4 h-4 text-indigo-600 rounded cursor-pointer"><span class="text-sm text-gray-700">Negative Marking</span></label>
        <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="eeShuffle" <%= exam.shuffle_questions ? 'checked' : '' %> class="w-4 h-4 text-indigo-600 rounded cursor-pointer"><span class="text-sm text-gray-700">Shuffle Questions</span></label>
        <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="eeShowResult" <%= exam.show_result_immediately ? 'checked' : '' %> class="w-4 h-4 text-indigo-600 rounded cursor-pointer"><span class="text-sm text-gray-700">Show Result Immediately</span></label>
        <label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="eeActive" <%= exam.is_active ? 'checked' : '' %> class="w-4 h-4 text-indigo-600 rounded cursor-pointer"><span class="text-sm text-gray-700">Active</span></label>
      </div>
      <div class="grid grid-cols-3 gap-3">
        <div><label class="block text-xs font-medium text-gray-600 mb-1">Exam Date</label><input type="date" id="eeDate" value="<%= exam.exam_date ? new Date(exam.exam_date).toISOString().split('T')[0] : '' %>" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
        <div><label class="block text-xs font-medium text-gray-600 mb-1">Start Time</label><input type="time" id="eeStartTime" value="<%= exam.start_time || '' %>" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
        <div><label class="block text-xs font-medium text-gray-600 mb-1">End Time</label><input type="time" id="eeEndTime" value="<%= exam.end_time || '' %>" class="w-full px-3 py-2 border rounded-lg text-sm"></div>
      </div>
      <div class="flex justify-end space-x-2 pt-2 border-t">
        <button type="button" onclick="closeEditExamModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-200 transition cursor-pointer">Cancel</button>
        <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm font-medium hover:bg-indigo-700 transition cursor-pointer">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<script>
const examId = <%= exam.id %>;
let editingSectionId = null;

// === Section Modal ===
function openSectionModal() {
  editingSectionId = null;
  document.getElementById('sectionModalTitle').textContent = 'Add Section';
  document.getElementById('sectionSaveBtn').textContent = 'Add Section';
  document.getElementById('sectionForm').reset();
  document.getElementById('sectionOrder').value = <%= sections.length + 1 %>;
  document.getElementById('sectionNumQ').value = 10;
  document.getElementById('sectionMarksPerQ').value = 1;
  document.getElementById('sectionTotalMarks').value = 10;
  document.getElementById('sectionMandatory').checked = true;
  document.getElementById('sectionModal').classList.remove('hidden');
}

function editSection(s) {
  editingSectionId = s.id;
  document.getElementById('sectionModalTitle').textContent = 'Edit Section';
  document.getElementById('sectionSaveBtn').textContent = 'Save Changes';
  document.getElementById('sectionTitle').value = s.title;
  document.getElementById('sectionType').value = s.section_type;
  document.getElementById('sectionOrder').value = s.sort_order;
  document.getElementById('sectionDesc').value = s.description || '';
  document.getElementById('sectionNumQ').value = s.num_questions;
  document.getElementById('sectionMarksPerQ').value = s.marks_per_question;
  document.getElementById('sectionTotalMarks').value = s.total_marks;
  document.getElementById('sectionTime').value = s.time_limit_minutes;
  document.getElementById('sectionMandatory').checked = s.is_mandatory;
  document.getElementById('sectionShuffle').checked = s.shuffle_questions;
  document.getElementById('sectionModal').classList.remove('hidden');
}

function closeSectionModal() { document.getElementById('sectionModal').classList.add('hidden'); }

function calcTotal() {
  const q = parseInt(document.getElementById('sectionNumQ').value) || 0;
  const m = parseInt(document.getElementById('sectionMarksPerQ').value) || 0;
  document.getElementById('sectionTotalMarks').value = q * m;
}

document.getElementById('sectionForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = {
    title: document.getElementById('sectionTitle').value,
    section_type: document.getElementById('sectionType').value,
    description: document.getElementById('sectionDesc').value,
    num_questions: parseInt(document.getElementById('sectionNumQ').value),
    marks_per_question: parseInt(document.getElementById('sectionMarksPerQ').value),
    time_limit_minutes: parseInt(document.getElementById('sectionTime').value),
    is_mandatory: document.getElementById('sectionMandatory').checked,
    shuffle_questions: document.getElementById('sectionShuffle').checked,
    sort_order: parseInt(document.getElementById('sectionOrder').value)
  };
  const url = editingSectionId
    ? `/admin/sections/${editingSectionId}/update`
    : `/admin/exams/${examId}/sections/create`;
  const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
  const result = await res.json();
  if (result.success) window.location.reload();
  else alert(result.error || 'Failed');
});

async function deleteSection(id, title) {
  if (!confirm(`Delete section "${title}" and all its questions?`)) return;
  const res = await fetch(`/admin/sections/${id}/delete`, { method: 'POST' });
  const data = await res.json();
  if (data.success) window.location.reload();
  else alert(data.error || 'Failed');
}

async function deleteQuestion(id) {
  if (!confirm('Delete this question?')) return;
  const res = await fetch(`/admin/questions/${id}/delete`, { method: 'POST' });
  const data = await res.json();
  if (data.success) window.location.reload();
  else alert(data.error || 'Failed');
}

// === Edit Exam Modal ===
function openEditExamModal() { document.getElementById('editExamModal').classList.remove('hidden'); }
function closeEditExamModal() { document.getElementById('editExamModal').classList.add('hidden'); }

document.getElementById('editExamForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const data = {
    title: document.getElementById('eeTitle').value,
    exam_code: document.getElementById('eeCode').value,
    description: document.getElementById('eeDesc').value,
    instructions: document.getElementById('eeInstructions').value,
    degree_id: document.getElementById('eeDegree').value || null,
    duration_minutes: parseInt(document.getElementById('eeDuration').value),
    passing_marks: parseInt(document.getElementById('eePassMarks').value),
    max_tab_switches: parseInt(document.getElementById('eeMaxTab').value),
    max_violations: parseInt(document.getElementById('eeMaxViol').value),
    negative_mark_value: parseFloat(document.getElementById('eeNegVal').value),
    auto_save_interval: parseInt(document.getElementById('eeAutoSave').value),
    negative_marking: document.getElementById('eeNeg').checked,
    shuffle_questions: document.getElementById('eeShuffle').checked,
    show_result_immediately: document.getElementById('eeShowResult').checked,
    is_active: document.getElementById('eeActive').checked,
    exam_date: document.getElementById('eeDate').value || null,
    start_time: document.getElementById('eeStartTime').value || null,
    end_time: document.getElementById('eeEndTime').value || null
  };
  const res = await fetch(`/admin/exams/${examId}/update`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
  const result = await res.json();
  if (result.success) window.location.reload();
  else alert(result.error || 'Failed');
});
</script>

<%- include('../partials/footer') %>
